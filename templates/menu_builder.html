{% extends "base.html" %}

{% macro render_tree(nodes, selected_id) -%}
<ul>
  {% for node in nodes %}
    <li>
      <a class="tree-node {% if selected_id and selected_id == node.id %}active{% endif %}" href="{{ url_for('menu_builder', node_id=node.id) }}">
        {{ node.title }}
      </a>
      {% if node.children %}
        {{ render_tree(node.children, selected_id) }}
      {% endif %}
    </li>
  {% endfor %}
</ul>
{%- endmacro %}

{% block content %}
<h1 class="section-title">Costruttore Bot</h1>

<div class="split-layout">
  <section class="tree-box">
    <h3>Struttura Bot</h3>
    {% if tree %}
      {{ render_tree(tree, selected_node.id if selected_node else none) }}
    {% else %}
      <div class="empty">Nessun nodo presente</div>
    {% endif %}

    <div class="hr"></div>

    <h4>Aggiungi Nodo</h4>
    <form method="post" action="{{ url_for('menu_new_node') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <div class="form-group">
        <label>Titolo</label>
        <input name="title" required maxlength="120" placeholder="Nuovo nodo">
      </div>
      <div class="form-group" style="margin-top:0.5rem;">
        <label>Nome interno</label>
        <input name="internal_name" maxlength="120" placeholder="nuovo_nodo">
      </div>
      <div class="form-group" style="margin-top:0.5rem;">
        <label>Nodo padre</label>
        <select name="parent_id">
          <option value="">(Radice)</option>
          {% for node in all_nodes %}
            <option value="{{ node.id }}" {% if selected_node and node.id == selected_node.id %}selected{% endif %}>#{{ node.id }} - {{ node.title }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group" style="margin-top:0.5rem;">
        <label>Ordine</label>
        <input name="sort_order" type="number" min="0" max="9999" value="0">
      </div>
      <div class="form-group" style="margin-top:0.5rem;">
        <label>Testo messaggio</label>
        <textarea name="message_text" placeholder="Messaggio del nodo"></textarea>
      </div>
      <button class="btn primary" style="margin-top:0.65rem; width:100%;">Crea Nodo</button>
    </form>

    <div class="hr"></div>
    <div class="action-row">
      <a class="btn" href="{{ url_for('menu_export') }}">Esporta JSON</a>
    </div>
    <form method="post" action="{{ url_for('menu_import') }}" enctype="multipart/form-data" style="margin-top:0.6rem;">
      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
      <input type="file" name="menu_file" accept="application/json" required>
      <button class="btn" style="margin-top:0.5rem; width:100%;">Importa JSON</button>
    </form>
  </section>

  <section class="card">
    {% if selected_node %}
      <h3>Propriet√† Nodo: {{ selected_node.title }}</h3>
      <form method="post" action="{{ url_for('menu_update_node', node_id=selected_node.id) }}" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <div class="form-grid">
          <div class="form-group">
            <label>Titolo</label>
            <input name="title" value="{{ selected_node.title }}" maxlength="120" required>
          </div>

          <div class="form-group">
            <label>Nome interno</label>
            <input name="internal_name" value="{{ selected_node.internal_name }}" maxlength="120" required>
          </div>

          <div class="form-group full">
            <label>Testo Messaggio</label>
            <textarea name="message_text">{{ selected_node.message_text }}</textarea>
          </div>

          <div class="form-group">
            <label>Ordine</label>
            <input type="number" name="sort_order" min="0" max="9999" value="{{ selected_node.sort_order }}">
          </div>

          <div class="form-group">
            <label>Carica immagine (PNG/JPG/GIF/WEBP)</label>
            <input type="file" name="media_file" accept="image/*">
          </div>

          <div class="form-group full">
            <label>
              <input type="checkbox" name="remove_media" value="1" style="width:auto;"> Rimuovi media corrente
            </label>
            {% if selected_node.media_path %}
              <div class="metric-sub">Media attuale: <code>{{ selected_node.media_path }}</code></div>
            {% endif %}
          </div>
        </div>

        <div class="action-row" style="margin-top:0.8rem;">
          <button class="btn primary" type="submit">Salva Nodo</button>
        </div>
      </form>

      <form method="post" action="{{ url_for('menu_delete_node', node_id=selected_node.id) }}" data-confirm="Eliminare questo nodo e tutti i sotto-nodi?" style="margin-top:0.8rem;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="btn danger" type="submit">Elimina Nodo</button>
      </form>

      <div class="hr"></div>
      <h3>Pulsanti Nodo</h3>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Etichetta</th>
              <th>Azione</th>
              <th>Valore</th>
              <th>Riga</th>
              <th>Ord.</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for btn in selected_buttons %}
              <tr>
                <td colspan="6">
                  <form method="post" action="{{ url_for('menu_update_button', button_id=btn.id) }}" class="action-row">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input style="max-width:180px;" name="label" value="{{ btn.label }}" maxlength="80" required>
                    <select name="action_type" style="max-width:180px;">
                      {% for action in action_types %}
                        <option value="{{ action }}" {% if action == btn.action_type %}selected{% endif %}>{{ action }}</option>
                      {% endfor %}
                    </select>
                    <input style="min-width:220px;" name="action_value" value="{{ btn.action_value }}" list="node-targets-{{ selected_node.id }}" placeholder="ID nodo o testo/immagine/item">
                    <input style="max-width:70px;" type="number" name="row_index" min="0" max="50" value="{{ btn.row_index }}">
                    <input style="max-width:70px;" type="number" name="sort_order" min="0" max="50" value="{{ btn.sort_order }}">
                    <button class="btn" type="submit">Aggiorna</button>
                  </form>
                  <form method="post" action="{{ url_for('menu_delete_button', button_id=btn.id) }}" class="inline-form" data-confirm="Eliminare questo pulsante?" style="margin-top:0.4rem; display:block;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button class="btn danger" type="submit">Elimina</button>
                  </form>
                </td>
              </tr>
            {% else %}
              <tr><td colspan="6" class="empty">Nessun pulsante configurato</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <datalist id="node-targets-{{ selected_node.id }}">
        {% for node in all_nodes %}
          <option value="{{ node.id }}">#{{ node.id }} - {{ node.title }}</option>
        {% endfor %}
      </datalist>

      <h4 style="margin-top:1rem;">Aggiungi Pulsante</h4>
      <form method="post" action="{{ url_for('menu_add_button', node_id=selected_node.id) }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div class="form-grid">
          <div class="form-group">
            <label>Etichetta</label>
            <input name="label" maxlength="80" required placeholder="Nome pulsante">
          </div>
          <div class="form-group">
            <label>Azione</label>
            <select name="action_type">
              {% for action in action_types %}
                <option value="{{ action }}">{{ action }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group full">
            <label>Valore azione</label>
            <input name="action_value" list="node-targets-{{ selected_node.id }}" placeholder="OPEN_NODE: ID nodo | SEND_TEXT: testo | OPEN_ORDER_FORM: nome articolo">
          </div>
          <div class="form-group">
            <label>Riga</label>
            <input type="number" name="row_index" min="0" max="50" value="0">
          </div>
          <div class="form-group">
            <label>Ordine</label>
            <input type="number" name="sort_order" min="0" max="50" value="0">
          </div>
        </div>
        <button class="btn primary" style="margin-top:0.8rem;">Aggiungi Pulsante</button>
      </form>
    {% else %}
      <div class="empty">Seleziona o crea un nodo dal menu a sinistra.</div>
    {% endif %}
  </section>
</div>
{% endblock %}
